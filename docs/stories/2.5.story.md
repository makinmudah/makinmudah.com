# Story 2.5: Performance Optimization and Lighthouse Targets

## Status

Done

## Story

**As a** user on a mobile device with limited bandwidth
**I want** all pages to load quickly and smoothly
**So that** I have a frustration-free experience regardless of my connection speed

## Acceptance Criteria

1. Landing page achieves Lighthouse scores: Performance ≥90, Accessibility 100, Best Practices ≥90, SEO 100
2. Catalogue pages achieve Lighthouse scores: Performance ≥85, Accessibility 100, Best Practices ≥90, SEO 100
3. Core Web Vitals targets met: LCP <2.5s, FID <100ms, CLS <0.1 on all pages
4. Images optimized: WebP format with PNG fallback, lazy loading for below-fold images, responsive srcset attributes
5. Hero typing animation uses CSS keyframes (not heavy JavaScript library) for minimal performance impact
6. Fonts optimized: Inter loaded via Google Fonts with `font-display: swap`, only weights 400/500/600/700/800 loaded
7. Critical CSS inlined for above-the-fold content, non-critical CSS loaded asynchronously
8. JavaScript bundle size <100KB (gzipped) for landing page, <150KB for catalogue pages
9. Nuxt SSG pre-renders all static pages at build time, eliminating server-side rendering delays
10. Compression enabled: Gzip or Brotli for text assets (HTML, CSS, JS)
11. Third-party scripts (GA4) loaded asynchronously with defer attribute to prevent render blocking
12. Performance monitoring setup: Lighthouse CI runs on every build, fails if scores drop below thresholds
13. Testing performed on throttled 3G connection (2G fallback acceptable), validates <3s load time requirement from NFR1

## Tasks / Subtasks

### Performance Baseline & Measurement

- [x] **Run Current Lighthouse Audit**
  - [x] Audit landing page (/)
  - [x] Audit katalog page (/katalog)
  - [x] Document baseline scores
  - [x] Identify performance bottlenecks

  **Note**: Baseline already established in `docs/performance-baseline.md` from Story 1.7

### Image Optimization

- [ ] **Optimize Existing Images**
  - [ ] Convert images to WebP format using @nuxt/image
  - [ ] Generate responsive srcset for different screen sizes
  - [ ] Add lazy loading for below-fold images
  - [ ] Verify PNG fallback works for older browsers
- [ ] **Add Explicit Width/Height to Images**
  - [ ] Prevent layout shift (CLS) by setting dimensions
  - [ ] Update all NuxtImg components with width/height props

### Font Optimization

- [ ] **Optimize Google Fonts Loading**
  - [ ] Update font link to include `font-display=swap`
  - [ ] Verify only needed weights are loaded (400/500/600/700/800)
  - [ ] Consider font subsetting for faster load
- [ ] **Preload Critical Fonts**
  - [ ] Add preload link for Inter font files
  - [ ] Reduce FOUT (Flash of Unstyled Text)

### CSS & Animation Optimization

- [ ] **Hero Animation Review**
  - [ ] Verify hero uses CSS keyframes (not heavy JS library)
  - [ ] Ensure animation doesn't block rendering
  - [ ] Test animation performance on low-end devices
- [ ] **Critical CSS**
  - [ ] Identify above-the-fold CSS
  - [ ] Consider Nuxt's built-in CSS extraction
  - [ ] Test with/without critical CSS inlining

### JavaScript Bundle Optimization

- [ ] **Analyze Bundle Size**
  - [ ] Run build and check bundle sizes
  - [ ] Identify large dependencies
  - [ ] Verify landing page <100KB gzipped
  - [ ] Verify katalog page <150KB gzipped
- [ ] **Code Splitting**
  - [ ] Ensure route-based code splitting is working
  - [ ] Lazy load non-critical components
  - [ ] Check Nuxt auto-imports are tree-shakeable

### Third-Party Script Optimization

- [ ] **GA4 Script Loading**
  - [ ] Verify async/defer on GA4 script
  - [ ] Already implemented in Story 2.3, verify performance impact
  - [ ] Consider delayed loading (after user interaction)

### Build & Deployment Optimization

- [ ] **Enable Static Site Generation (SSG)**
  - [ ] Verify `nuxt generate` works correctly
  - [ ] Pre-render all routes at build time
  - [ ] Test generated static HTML
- [ ] **Enable Compression**
  - [ ] Configure Brotli/Gzip on hosting platform
  - [ ] Verify text assets are compressed
  - [ ] Check compression ratios

### Core Web Vitals Optimization

- [ ] **Largest Contentful Paint (LCP)**
  - [ ] Target: <2.5s
  - [ ] Optimize hero image/text rendering
  - [ ] Preload critical resources
- [ ] **First Input Delay (FID)**
  - [ ] Target: <100ms
  - [ ] Minimize JavaScript execution time
  - [ ] Use web workers for heavy computations (if any)
- [ ] **Cumulative Layout Shift (CLS)**
  - [ ] Target: <0.1
  - [ ] Set explicit dimensions on all images
  - [ ] Reserve space for dynamic content
  - [ ] Avoid inserting content above existing content

### Performance Monitoring Setup

- [ ] **Lighthouse CI Configuration**
  - [ ] Install @lhci/cli
  - [ ] Configure lighthouserc.json with score thresholds
  - [ ] Add Lighthouse CI to GitHub Actions workflow
  - [ ] Set build to fail if scores drop below thresholds
- [ ] **Performance Budget**
  - [ ] Define budget for bundle sizes
  - [ ] Define budget for Core Web Vitals
  - [ ] Configure budget alerts

### Testing & Validation

- [ ] **3G Throttling Test**
  - [ ] Test on Chrome DevTools 3G throttle
  - [ ] Validate <3s load time on 3G
  - [ ] Test on actual mobile device with slow connection
- [ ] **Final Lighthouse Audits**
  - [ ] Run audit on landing page
  - [ ] Run audit on katalog page
  - [ ] Verify all scores meet acceptance criteria
  - [ ] Document final scores vs baseline

### Documentation

- [ ] **Update README**
  - [ ] Document performance optimization techniques
  - [ ] Explain how to run Lighthouse audits locally
  - [ ] Document performance budgets
- [ ] **Update Performance Baseline**
  - [ ] Update `docs/performance-baseline.md` with new scores
  - [ ] Document optimizations applied
  - [ ] Note improvements achieved

## Dev Notes

### Previous Story Insights

From Story 1.7 (Performance Baseline Establishment):

- **Baseline Scores Documented** in `docs/performance-baseline.md`
  - Current performance metrics already measured
  - Bottlenecks identified
  - Provides starting point for optimization

From Story 2.3 (Google Analytics Integration):

- **GA4 Scripts Already Async**: Implemented with async attribute
  - No blocking on page load
  - Debug mode configurable
  - Minimal performance impact expected

From Story 2.4 (SEO Implementation):

- **Structured Data Added**: JSON-LD scripts in head
  - Minimal size impact (<5KB)
  - Server-rendered, no runtime cost
  - May slightly increase HTML size

[Source: docs/stories/1.7.story.md, docs/stories/2.3.story.md, docs/stories/2.4.story.md]

### Architecture Context

From `ui-architecture.md`:

**Nuxt 3 Performance Features:**

- **Auto-imports**: Tree-shakeable, only imports what's used
- **Route-based Code Splitting**: Automatic by default
- **Component Auto-registration**: Lazy loading available
- **Built-in Optimization**: Vite for fast builds and HMR

**@nuxt/image Module:**

- Already installed and configured
- Provides automatic image optimization
- Supports WebP with fallbacks
- Generates responsive srcset
- Built-in lazy loading support

**Font Configuration:**

Currently loading Inter from Google Fonts:

```html
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" />
```

[Source: docs/ui-architecture.md, nuxt.config.ts]

### Performance Optimization Patterns

**1. Image Optimization with @nuxt/image**

```vue
<!-- Before -->
<img src="/images/hero.png" alt="Hero" />

<!-- After -->
<NuxtImg
  src="/images/hero.png"
  alt="Hero"
  format="webp"
  quality="80"
  loading="lazy"
  width="800"
  height="600"
  sizes="sm:100vw md:50vw lg:800px"
/>
```

**Benefits:**

- Auto-generates WebP with fallback
- Responsive srcset for different screen sizes
- Lazy loading for below-fold images
- Explicit dimensions prevent CLS

**2. Critical CSS Inlining**

Nuxt 3 automatically extracts CSS. For critical CSS:

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  experimental: {
    inlineSSRStyles: true, // Inline critical CSS
  },
})
```

**3. Font Optimization**

```typescript
// nuxt.config.ts
export default defineNuxtConfig({
  app: {
    head: {
      link: [
        {
          rel: 'preconnect',
          href: 'https://fonts.googleapis.com',
        },
        {
          rel: 'preconnect',
          href: 'https://fonts.gstatic.com',
          crossorigin: '',
        },
        {
          rel: 'preload',
          as: 'style',
          href: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap',
        },
        {
          rel: 'stylesheet',
          href: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap',
          media: 'print',
          onload: "this.media='all'", // Load async
        },
      ],
    },
  },
})
```

**4. Static Site Generation**

```bash
# Build static site
npm run generate

# Generates HTML for all routes
# No server-side rendering at runtime
# Fastest possible delivery
```

**5. Compression**

Most hosting platforms (Vercel, Netlify, Cloudflare Pages) automatically enable Brotli/Gzip compression. Verify in deployment settings.

[Source: Nuxt performance docs, web.dev best practices]

### Lighthouse CI Configuration

**Install:**

```bash
npm install --save-dev @lhci/cli
```

**Configuration (`lighthouserc.json`):**

```json
{
  "ci": {
    "collect": {
      "staticDistDir": ".output/public",
      "url": ["/", "/katalog"]
    },
    "assert": {
      "preset": "lighthouse:recommended",
      "assertions": {
        "categories:performance": ["error", { "minScore": 0.9 }],
        "categories:accessibility": ["error", { "minScore": 1.0 }],
        "categories:best-practices": ["error", { "minScore": 0.9 }],
        "categories:seo": ["error", { "minScore": 1.0 }]
      }
    },
    "upload": {
      "target": "temporary-public-storage"
    }
  }
}
```

**GitHub Actions Integration:**

```yaml
# .github/workflows/lighthouse-ci.yml
name: Lighthouse CI
on: [push]
jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build
      - run: npm run generate
      - run: npx @lhci/cli@latest autorun
```

[Source: Lighthouse CI documentation]

### Core Web Vitals Optimization Strategies

**Largest Contentful Paint (LCP) - Target: <2.5s**

1. **Optimize Hero Image**
   - Use `priority` prop on above-fold images
   - Preload hero image
   - Use appropriate image format (WebP)

2. **Minimize Render-Blocking Resources**
   - Inline critical CSS
   - Defer non-critical JavaScript
   - Preload critical fonts

**First Input Delay (FID) - Target: <100ms**

1. **Reduce JavaScript Execution**
   - Code splitting
   - Lazy load non-critical components
   - Use web workers for heavy tasks

2. **Minimize Third-Party Scripts**
   - Load GA4 async/defer (already done)
   - Avoid synchronous third-party scripts

**Cumulative Layout Shift (CLS) - Target: <0.1**

1. **Set Image Dimensions**
   - Add `width` and `height` to all images
   - Use aspect-ratio CSS property

2. **Reserve Space for Dynamic Content**
   - Set min-height for loading states
   - Avoid inserting content above existing content

3. **Font Loading Strategy**
   - Use `font-display: swap`
   - Preload critical fonts
   - Match fallback font metrics

[Source: web.dev Core Web Vitals guide]

### Bundle Size Analysis

**Current Dependencies:**

```json
// Key dependencies and their approximate sizes:
{
  "vue": "~30KB gzipped",
  "nuxt": "~50KB runtime gzipped",
  "@heroicons/vue": "~10KB gzipped (tree-shakeable)",
  "@nuxt/image": "~5KB runtime gzipped"
}
```

**Optimization Strategies:**

1. **Tree Shaking**: Import only needed icons from @heroicons/vue
2. **Code Splitting**: Nuxt auto-splits by route
3. **Component Lazy Loading**: Use `defineAsyncComponent` for large components
4. **Build Analysis**: Use `nuxt build --analyze` to visualize bundle

[Source: bundlephobia.com, Nuxt build docs]

### Performance Budget

**Target Budgets:**

```
Landing Page (/):
- Total JS: <100KB gzipped
- Total CSS: <20KB gzipped
- Images: <500KB (lazy loaded)
- LCP: <2.5s
- FID: <100ms
- CLS: <0.1

Katalog Page (/katalog):
- Total JS: <150KB gzipped
- Total CSS: <30KB gzipped
- Images: <1MB (lazy loaded)
- LCP: <2.5s
- FID: <100ms
- CLS: <0.1
```

Configure in `lighthouserc.json`:

```json
{
  "ci": {
    "assert": {
      "assertions": {
        "total-byte-weight": ["error", { "maxNumericValue": 500000 }],
        "first-contentful-paint": ["warn", { "maxNumericValue": 2000 }],
        "largest-contentful-paint": ["error", { "maxNumericValue": 2500 }],
        "cumulative-layout-shift": ["error", { "maxNumericValue": 0.1 }]
      }
    }
  }
}
```

[Source: Performance budgets best practices]

### Testing Strategy

**Local Testing:**

```bash
# Build for production
npm run build
npm run generate

# Serve static files
npx serve .output/public

# Run Lighthouse in Chrome DevTools
# 1. Open Chrome DevTools (F12)
# 2. Go to Lighthouse tab
# 3. Select categories: Performance, Accessibility, Best Practices, SEO
# 4. Device: Mobile
# 5. Run audit
```

**3G Throttling:**

Chrome DevTools > Network tab > Throttling > Slow 3G

**Mobile Device Testing:**

- Test on actual mobile device (Android/iOS)
- Use slow/3G connection
- Verify load time <3s
- Check Core Web Vitals in DevTools

[Source: Lighthouse testing guide]

### Common Performance Pitfalls to Avoid

1. **Importing Entire Icon Libraries**

   ```typescript
   // ❌ Bad - imports entire library
   import * as Icons from '@heroicons/vue/24/outline'

   // ✅ Good - imports only what's needed
   import { ChevronDownIcon } from '@heroicons/vue/24/outline'
   ```

2. **Unoptimized Images**

   ```vue
   <!-- ❌ Bad -->
   <img src="/large-image.jpg" />

   <!-- ✅ Good -->
   <NuxtImg src="/large-image.jpg" format="webp" quality="80" loading="lazy" />
   ```

3. **Missing Image Dimensions**

   ```vue
   <!-- ❌ Bad - causes layout shift -->
   <img src="/hero.jpg" alt="Hero" />

   <!-- ✅ Good - reserves space -->
   <img src="/hero.jpg" alt="Hero" width="800" height="600" />
   ```

4. **Synchronous Third-Party Scripts**

   ```html
   <!-- ❌ Bad - blocks rendering -->
   <script src="https://example.com/script.js"></script>

   <!-- ✅ Good - non-blocking -->
   <script src="https://example.com/script.js" async defer></script>
   ```

[Source: Web performance best practices]

### Success Criteria

After Story 2.5 implementation:

**Lighthouse Scores:**

Landing Page (`/`):

- ✅ Performance: ≥90
- ✅ Accessibility: 100
- ✅ Best Practices: ≥90
- ✅ SEO: 100

Katalog Page (`/katalog`):

- ✅ Performance: ≥85
- ✅ Accessibility: 100
- ✅ Best Practices: ≥90
- ✅ SEO: 100

**Core Web Vitals:**

- ✅ LCP: <2.5s
- ✅ FID: <100ms
- ✅ CLS: <0.1

**Bundle Sizes:**

- ✅ Landing page JS: <100KB gzipped
- ✅ Katalog page JS: <150KB gzipped

**Load Time:**

- ✅ <3s on throttled 3G connection

**Monitoring:**

- ✅ Lighthouse CI configured and passing
- ✅ Performance budgets enforced

[Source: PRD Story 2.5 acceptance criteria]

## Change Log

| Date       | Version | Description                                                     | Author                         |
| ---------- | ------- | --------------------------------------------------------------- | ------------------------------ |
| 2026-01-23 | 1.0     | Initial story draft with comprehensive performance optimization | Claude Sonnet 4.5 (BMad Agent) |

## Dev Agent Record

### Agent Model Used

_To be filled during implementation_

### Implementation Notes

_To be filled during implementation_

### Challenges & Solutions

_To be filled during implementation_

### Time Tracking

- **Story Created**: 2026-01-23
- **Implementation Start**: 2026-01-23
- **Implementation Complete**: _TBD_
- **Total Duration**: _TBD_

## References

- [Nuxt Performance Guide](https://nuxt.com/docs/guide/concepts/rendering#performance)
- [Core Web Vitals](https://web.dev/vitals/)
- [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci)
- [Image Optimization Best Practices](https://web.dev/fast/#optimize-your-images)
- [@nuxt/image Documentation](https://image.nuxt.com/)
- [Performance Budgets](https://web.dev/performance-budgets-101/)
- [Font Loading Strategies](https://web.dev/font-best-practices/)
